/*!
 * @grapecity/activereports 4.2.1
 * Description: ActiveReportsJS
 * https://www.npmjs.com/package/@grapecity/activereports
 * Copyright ©️ Respective Holders. All rights reserved.
 * Licensed under the Commercial license
 */
import{__awaiter as t,__rest as e}from"tslib";import*as n from"./ar-js-pagereport";import o from"jszip";var i=Object.freeze({__proto__:null,get exportDocument(){return v}});const a=window||global;a&&(a["@grapecity/ar-js-html"]=i);"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var r={exports:{}},l=r.exports=function t(e,n,o){var i,a,r=window,l="application/octet-stream",s=o||l,d=e,c=!n&&!o&&d,u=document.createElement("a"),p=function(t){return String(t)},m=r.Blob||r.MozBlob||r.WebKitBlob||p,g=n||"download";if(m=m.call?m.bind(r):Blob,"true"===String(this)&&(s=(d=[d,s])[0],d=d[1]),c&&c.length<2048&&(g=c.split("/").pop().split("?")[0],u.href=c,-1!==u.href.indexOf(c))){var f=new XMLHttpRequest;return f.open("GET",c,!0),f.responseType="blob",f.onload=function(e){t(e.target.response,g,l)},setTimeout((function(){f.send()}),0),f}if(/^data:([\w+-]+\/[\w+.-]+)?[,;]/.test(d)){if(!(d.length>2096103.424&&m!==p))return navigator.msSaveBlob?navigator.msSaveBlob(w(d),g):v(d);s=(d=w(d)).type||l}else if(/([\x80-\xff])/.test(d)){for(var y=0,h=new Uint8Array(d.length),b=h.length;y<b;++y)h[y]=d.charCodeAt(y);d=new m([h],{type:s})}function w(t){for(var e=t.split(/[:;,]/),n=e[1],o=("base64"==e[2]?atob:decodeURIComponent)(e.pop()),i=o.length,a=0,r=new Uint8Array(i);a<i;++a)r[a]=o.charCodeAt(a);return new m([r],{type:n})}function v(t,e){if("download"in u)return u.href=t,u.setAttribute("download",g),u.className="download-js-link",u.innerHTML="downloading...",u.style.display="none",document.body.appendChild(u),setTimeout((function(){u.click(),document.body.removeChild(u),!0===e&&setTimeout((function(){r.URL.revokeObjectURL(u.href)}),250)}),66),!0;if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent))return/^data:/.test(t)&&(t="data:"+t.replace(/^data:([\w\/\-\+]+)/,l)),window.open(t)||confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")&&(location.href=t),!0;var n=document.createElement("iframe");document.body.appendChild(n),!e&&/^data:/.test(t)&&(t="data:"+t.replace(/^data:([\w\/\-\+]+)/,l)),n.src=t,setTimeout((function(){document.body.removeChild(n)}),333)}if(i=d instanceof m?d:new m([d],{type:s}),navigator.msSaveBlob)return navigator.msSaveBlob(i,g);if(r.URL)v(r.URL.createObjectURL(i),!0);else{if("string"==typeof i||i.constructor===p)try{return v("data:"+s+";base64,"+r.btoa(i))}catch(t){return v("data:"+s+","+encodeURIComponent(i))}(a=new FileReader).onload=function(t){v(this.result)},a.readAsDataURL(i)}return!0};function s(t){let e=0;if(t){const n=t.toLowerCase();for(let t=0;t<n.length;t++)e=(e<<5)-e+n.charCodeAt(t),e&=e}return(e>=0?"":"_")+Math.abs(e).toString(16).toUpperCase()}function d(t,e){if(t&&e)try{t.removeChild(e)}catch(t){}}function c(t,e="untitled"){if("string"==typeof t){const n=new Blob([t],{type:"text/html"});l(n,e+".html","text/html")}else l(t,e+".zip","application/zip")}const u=/(?:background-image:\s*)url\(['"]((?!data:).*?)['"]\)/g,p=/^background-image:\s*/i;function m(e,n,o){return t(this,void 0,void 0,(function*(){if(e&&n.embedImages&&"none"!==n.embedImages){if(e.style.backgroundImage&&e.style.backgroundImage.match(/url\(['"](?!data:)/i)){const t=e.style.backgroundImage;yield g(t,n,o,(t=>{e.style.backgroundImage=`url("${t}")`}))}for(let t=0;t<e.children.length;t++)yield m(e.children[t],n,o)}}))}function g(e,n,o,i){return t(this,void 0,void 0,(function*(){const t=yield f(e,o);t?"embed"===n.embedImages?i(t):(o[e]||(o[e]=((t,e)=>({name:`./data/${s(t)}.${y(e)}`,dataUri:e}))(e,t)),i(o[e].name)):o[e]={name:"",dataUri:""}}))}const f=(e,n)=>t(void 0,void 0,void 0,(function*(){return n[e]?n[e].dataUri:yield function(e){return t(this,void 0,void 0,(function*(){return new Promise((t=>{try{const n=new XMLHttpRequest;n.onload=()=>{const e=new FileReader;e.onloadend=()=>{let o=e.result;const i=n.getAllResponseHeaders().includes("contentType")?n.getResponseHeader("contentType"):"";i&&(o=o.replace(/^data:application\/octet-stream;/i,`data:${i};`)),t(o)},e.readAsDataURL(n.response)},n.onerror=()=>{console.warn(`Cannot download image data from "${e}"`),t(null)},n.open("GET",e,!0),n.responseType="blob",n.send()}catch(e){console.warn(e.message),t(null)}}))}))}(e.replace(/^url\(['"]/i,"").replace(/['"]\)$/i,""))}));function y(t){switch((t.toLowerCase().match(/^data:(image\/.+?);.+$/i)||[])[1]){case"image/png":return"png";case"image/jpeg":return"jpg";case"image/gif":return"gif";case"image/svg+xml":return"svg";default:return"dat"}}const h=t=>t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");const b=n.arjsStyles.replace("arjs-hide-screen","arjs-hide-export");const w=t=>"zip"===t.outputType||"external"===t.embedImages||!!t.multiPage;function v(e,n={},i,a){return t(this,void 0,void 0,(function*(){const r=Object.assign({outputType:"auto",embedImages:"none",multiPage:!1,autoPrint:!1,title:"Report"},n);let l;l=(t=>t&&t.getContent&&"function"==typeof t.getContent)(e)?e:yield e.runRenderer(Object.assign({galleyMode:!1,interactivityActions:[]},r&&r.renderOptions));const s=l.i18n,f=s.t("exporthtml:messages.cancel-message","Export process was cancelled by user"),y=l.render();for(;!y.next().done;)if(a&&a())return new Promise(((t,e)=>{e(f)}));const v=Object.getPrototypeOf(l).constructor.renderToDOM,{pages:C,patches:j,styles:k}=l.getContent(),P={},$=document.createElement("style"),R=Object.getPrototypeOf(l).constructor.getCssString,A=l.getFontFaces(),E=k.filter((t=>t.className)).map((t=>`.${t.className} {${R(t.style)}}`)).join(" ")+"\n"+A;$.innerText=E,document.body.appendChild($);const I=yield function(e,n,o){return t(this,void 0,void 0,(function*(){if(!n.embedImages||"none"===n.embedImages)return e;let t=e;const i=t.match(u)||[];for(const e of i){const i=e.replace(p,"");yield g(i,n,o,(e=>{t=t.replace(new RegExp(h(i),"g"),`url("${e}")`)}))}return t}))}(E,r,P),U=document.createElement("div");U.style.position="absolute",U.style.visibility="hidden",U.style.top="0px",U.style.left="0px",U.style.width="10px",U.style.height="10px",U.style.overflow="hidden",document.body.appendChild(U);const O=()=>{d(document.body,$),d(document.body,U)};let L=0,z=null;const S=()=>new Promise((e=>{z&&U.removeChild(z),L>=C.length?e(null):(z=v(C[L],j[L],{hideInteractivity:!0}),z?(U.appendChild(z),L++,setTimeout((()=>t(this,void 0,void 0,(function*(){z&&U.removeChild(z),yield m(z,r,P);const t=z&&z.outerHTML,n=z&&{width:z.style.width,height:z.style.height};z=null,e(t&&n?{html:t,size:n}:null)}))),20)):e(null))}));return new Promise(((e,n)=>t(this,void 0,void 0,(function*(){try{!function(t,e){if("html"===t.outputType){if(t.multiPage)throw new Error(e.t("exporthtml:messages.multipage-is-zip-only",'Multi page export is available only for "zip" output type'));if("external"===t.embedImages)throw new Error(e.t("exporthtml:messages.embedimages-is-zip-only",'Embed images as external files is available only for "zip" output type'))}}(r,s);let l=0,d=yield S();if(!d)return O(),void n(s.t("exporthtml:messages.first-page-render-failed","First page render failed"));const u=()=>t(this,void 0,void 0,(function*(){const t=[];let e=null;for(;d;){if(i&&i(l+1),t.push(d.html),e=!e&&d.size,l++,a&&a())return O(),n(f),"";d=yield S()}return O(),x(t.join("\n"),I,e,r)}));if(w(r)){const t=new o;if(r.multiPage){const e=[];for(;d;){i&&i(l+1);const t=x(d.html,I,d.size,r);if(e.push(t),l++,a&&a())return O(),void n(f);d=yield S()}for(let o=0;o<e.length;o++){if(a&&a())return O(),void n(f);t.file(T(o,e.length),e[o])}}else{const e=yield u();t.file("index.html",e)}t.file("styles.css",I+"\n\n"+b);const s=Object.values(P).filter((t=>!!t.name&&!!t.dataUri));if(s.length>0){const e=t.folder("data");s.forEach((t=>{e.file(t.name.replace("./data/",""),function(t){const e=atob(t.split(",")[1]),n=new ArrayBuffer(e.length),o=new Uint8Array(n);for(let t=0;t<e.length;t++)o[t]=e.charCodeAt(t);return new Blob([n],{type:t.split(",")[0].split(":")[1].split(";")[0]})}(t.dataUri))}))}const p=yield t.generateAsync({type:"blob"});O(),e({data:p,download:t=>c(p,t)})}else{const t=yield u();e({data:t,download:e=>c(t,e)})}}catch(t){O(),n(t.message)}}))))}))}function x(t,e,n,o={}){return`<!DOCTYPE html>\n<html>\n\t<head>\n\t\t<meta charset="utf-8">\n\t\t<title>${o.title||"Report"}</title>\n\t\t<style>\n\t\t\tbody {\n\t\t\t\tmargin: 0pt;\n\t\t\t\tpadding: 0pt;\n\t\t\t}\n\t\t\t.arjs-reportPage {\n\t\t\t\tpage-break-after: always;\n\t\t\t}\n\t\t\t@page {\n\t\t\t\tmargin: 0mm;${n?`\n\t\t\t\tsize: ${n.width} ${n.height};`:""}\n\t\t\t}\n${o.autoPrint?"\n\t\t\t@media screen {\n\t\t\t\t.arjs-reportPage {\n\t\t\t\t\tdisplay: none !important;\n\t\t\t\t}\n\t\t\t}\n\t\t\t@media print {\n\t\t\t\t.arjs-reportPage {\n\t\t\t\t\tdisplay: block !important;\n\t\t\t\t}\n\t\t\t}":""}\n\t\t</style>\n\t\t${w(o)?'<link rel="stylesheet" href="./styles.css">':`<style>${b}</style>\n\t\t<style>${e}</style>`}\n\t</head>\n\t<body>\n\t\t${t}\n\t</body>\n\t<script>\n\t\tfunction onActionClick(event) {\n\t\t\tvar action = event && event.target && event.target.dataset && event.target.dataset.action && JSON.parse(event.target.dataset.action);\n\t\t\tif (action) {\n\t\t\t\tswitch (action.Type) {\n\t\t\t\t\tcase "hyperlink": window.open(action.Target, "_blank"); break;\n\t\t\t\t\tcase "bookmark": window.location.href = window.location.href.replace(window.location.hash, "") + "#" + action.Target; break;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tdocument.addEventListener("click", onActionClick);\n\t<\/script>\n\t${o.autoPrint?"<script> setTimeout(function(){ window.print(); window.close(); }, 0) <\/script>":""}\n</html>`}const T=(t,e)=>{let n=(t+1).toString();const o=e.toString().length;for(;n.length<o;)n="0"+n;return`page_${n}.html`};!function(){if(window&&window.arjsViewer&&"function"==typeof window.arjsViewer.registerExport){const n={formatKey:"html",friendlyName:"HTML file",settingsDescriptors:[{name:"title",type:"string",label:"Title"},{name:"multiPage",type:"bool",label:"Multi Page",category:"output"},{name:"embedImages",type:"enum",label:"Embed Images",enumValues:{none:"None",embed:"Embed",external:"External"},category:"output"},{name:"outputType",type:"enum",label:"Output Type",enumValues:{auto:"Auto",html:"HTML",zip:"ZIP"},category:"output"},{name:"autoPrint",type:"bool",label:"Print on Open"},{name:"filename",type:"string",label:"File Name"}],defaultSettings:{filename:"ActiveReports",title:"Report",multiPage:!1,autoPrint:!1,embedImages:"none",outputType:"auto"},invoke:(n,o,i,a)=>t(this,void 0,void 0,(function*(){const{filename:t}=o,r=e(o,["filename"]),l=yield v(n._renderer,r,i,a);return{data:l.data,download:e=>l.download(e||t)}}))};window.arjsViewer.registerExport(n)}}();export{v as exportDocument};
