/*!
 * @grapecity/activereports 4.2.1
 * Description: ActiveReportsJS
 * https://www.npmjs.com/package/@grapecity/activereports
 * Copyright ©️ Respective Holders. All rights reserved.
 * Licensed under the Commercial license
 */
import{__awaiter as e,__rest as t}from"tslib";import o from"jszip";var r=Object.freeze({__proto__:null,get exportDocument(){return p}});const n=window||global;n&&(n["@grapecity/ar-js-tabular-data"]=r);"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var a={exports:{}},l=a.exports=function e(t,o,r){var n,a,l=window,i="application/octet-stream",c=r||i,s=t,u=!o&&!r&&s,p=document.createElement("a"),d=function(e){return String(e)},f=l.Blob||l.MozBlob||l.WebKitBlob||d,m=o||"download";if(f=f.call?f.bind(l):Blob,"true"===String(this)&&(c=(s=[s,c])[0],s=s[1]),u&&u.length<2048&&(m=u.split("/").pop().split("?")[0],p.href=u,-1!==p.href.indexOf(u))){var b=new XMLHttpRequest;return b.open("GET",u,!0),b.responseType="blob",b.onload=function(t){e(t.target.response,m,i)},setTimeout((function(){b.send()}),0),b}if(/^data:([\w+-]+\/[\w+.-]+)?[,;]/.test(s)){if(!(s.length>2096103.424&&f!==d))return navigator.msSaveBlob?navigator.msSaveBlob(g(s),m):S(s);c=(s=g(s)).type||i}else if(/([\x80-\xff])/.test(s)){for(var y=0,v=new Uint8Array(s.length),w=v.length;y<w;++y)v[y]=s.charCodeAt(y);s=new f([v],{type:c})}function g(e){for(var t=e.split(/[:;,]/),o=t[1],r=("base64"==t[2]?atob:decodeURIComponent)(t.pop()),n=r.length,a=0,l=new Uint8Array(n);a<n;++a)l[a]=r.charCodeAt(a);return new f([l],{type:o})}function S(e,t){if("download"in p)return p.href=e,p.setAttribute("download",m),p.className="download-js-link",p.innerHTML="downloading...",p.style.display="none",document.body.appendChild(p),setTimeout((function(){p.click(),document.body.removeChild(p),!0===t&&setTimeout((function(){l.URL.revokeObjectURL(p.href)}),250)}),66),!0;if(/(Version)\/(\d+)\.(\d+)(?:\.(\d+))?.*Safari\//.test(navigator.userAgent))return/^data:/.test(e)&&(e="data:"+e.replace(/^data:([\w\/\-\+]+)/,i)),window.open(e)||confirm("Displaying New Document\n\nUse Save As... to download, then click back to return to this page.")&&(location.href=e),!0;var o=document.createElement("iframe");document.body.appendChild(o),!t&&/^data:/.test(e)&&(e="data:"+e.replace(/^data:([\w\/\-\+]+)/,i)),o.src=e,setTimeout((function(){document.body.removeChild(o)}),333)}if(n=s instanceof f?s:new f([s],{type:c}),navigator.msSaveBlob)return navigator.msSaveBlob(n,m);if(l.URL)S(l.URL.createObjectURL(n),!0);else{if("string"==typeof n||n.constructor===d)try{return S("data:"+c+";base64,"+l.btoa(n))}catch(e){return S("data:"+c+","+encodeURIComponent(n))}(a=new FileReader).onload=function(e){S(this.result)},a.readAsDataURL(n)}return!0};function i(e){return Array.prototype.concat(...e)}const c=e=>e[e.length-1],s=e=>null!=e?e.replace(/\\n/g,"\n").replace(/\\r/g,"\r").replace(/\\t/g,"\t"):e;function u(e,t="untitled"){if("string"==typeof e){const o=new Blob(["\ufeff"+e],{type:"text/csv"});l(o,t+".csv","text/csv")}else l(e,t+".zip","application/zip")}function p(t,r,n,a){var l,c,s,p,m,b,y,v,w,g,S;return e(this,void 0,void 0,(function*(){let h;h=(e=>e&&e.getContent&&"function"==typeof e.getContent)(t)?t:yield t.runRenderer(Object.assign({galleyMode:!1,interactivityActions:[]},r&&r.renderOptions));const T={csvSettings:{colSeparator:null!==(c=null===(l=null==r?void 0:r.csvSettings)||void 0===l?void 0:l.colSeparator)&&void 0!==c?c:",",rowSeparator:null!==(p=null===(s=null==r?void 0:r.csvSettings)||void 0===s?void 0:s.rowSeparator)&&void 0!==p?p:"\n",tableSeparator:null!==(b=null===(m=null==r?void 0:r.csvSettings)||void 0===m?void 0:m.tableSeparator)&&void 0!==b?b:"===============",quotationSymbol:null!==(v=null===(y=null==r?void 0:r.csvSettings)||void 0===y?void 0:y.quotationSymbol)&&void 0!==v?v:'"',outputType:null!==(g=null===(w=null==r?void 0:r.csvSettings)||void 0===w?void 0:w.outputType)&&void 0!==g?g:"plain"},format:null!==(S=null==r?void 0:r.format)&&void 0!==S?S:"csv"},N=h.i18n,E=N.t("exportxlsx:messages.cancel-message","Export process was cancelled by user"),x=h.render();for(;!x.next().done;)if(a&&a())return new Promise(((e,t)=>{t(E)}));const{pages:R,patches:A}=h.getContent();let I=0;const j=()=>{var e;if(I>=R.length)return null;const t=R[I],o=i(null!==(e=A[I])&&void 0!==e?e:[]);return I++,{node:t,patches:o}};return new Promise(((t,r)=>e(this,void 0,void 0,(function*(){var l;try{if(a){const e=()=>{a()?r(E):setTimeout(e,2e3)};e()}let i=j();if(!i)return void r(N.t("exportxlsx:messages.first-page-render-failed","First page render failed"));const c=[];let s=1;for(;i;){if(a&&a())return void r(E);const e=d(i.node,"sliceIndex",0);c[e]=null!==(l=c[e])&&void 0!==l?l:[],c[e].push(i),n&&n(s),s++,i=j()}const p=[].concat(...c);if("csv"===T.format){const r=yield function(t,r){return e(this,void 0,void 0,(function*(){if("plain"===r.outputType){const e=f(t,r).map((e=>e.content)).join(`${r.rowSeparator}${r.tableSeparator}${r.rowSeparator}`);return{data:e,download:t=>u(e,t)}}{const e=new o,n=f(t,r);for(const t of n)e.file(t.name+".csv","\ufeff"+t.content);const a=yield e.generateAsync({type:"blob"});return{data:a,download:e=>u(a,e)}}}))}(p,T.csvSettings);t(r)}else r(N.t("exporttabulardata:messages.format-not-supported","Format is not supported"))}catch(e){r(e)}}))))}))}const d=(e,t,o)=>{var r,n;return null!==(n=null===(r=e.properties.meta)||void 0===r?void 0:r[t])&&void 0!==n?n:o};function f(e,t){const o=function(e){const t={},o=(e,r)=>{var n;if("TABLE"===e.tagName){const o=null===(n=e.properties.attributes)||void 0===n?void 0:n["data-name"];o&&(t[o]=t[o]||[],t[o].push(function(e,t){if("TABLE"!==e.tagName)throw new Error(`Expected <TABLE>, but was <${e.tagName}>`);const o=S(S(e,"TBODY")[0],"TR"),r=[];for(const e of o){const o=S(e,"TD"),n=[];for(const e of o){const o=h(e,t),r=d(e,"colNumber",-1),a=d(e,"rowNumber",-1),l=d(e,"scopeID",-1),i=d(e,"rowType","unknown"),c=d(e,"cellType","unknown"),s=e.properties.colSpan,u=e.properties.rowSpan;n.push({value:o,colNumber:r-s,rowSpan:u,rowNumber:a,scopeID:l,rowType:i,cellType:c});for(let e=1;e<s;e++)n.push({value:"",colNumber:r-s+e,rowSpan:u,rowNumber:a,scopeID:l,rowType:i,cellType:c})}r.push(n)}for(let e=0;e<r.length;e++)for(let t=0;t<r[e].length;t++)r[e][t].rowSpan>1&&r[e+1].splice(t,0,Object.assign(Object.assign({},r[e][t]),{value:"",rowSpan:r[e][t].rowSpan-1}));return r}(e,r)))}else e.children.filter((e=>"VirtualNode"===e.type)).forEach((e=>o(e,r)))};return e.forEach((e=>o(e.node,e.patches))),t}(e);return Object.keys(o).map((e=>({name:e,content:v(o[e],t)})))}function m(e,t){if(e.length!==t.length)throw new Error("Cannot join blocks of different lengths");const o=[...e];return t.forEach(((e,t)=>o[t].push(...e))),o}function b(e){let t=Number.MIN_SAFE_INTEGER,o=Number.MIN_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER,l=Number.MAX_SAFE_INTEGER;return e.forEach((e=>e.forEach((e=>{"details"===e.rowType&&(e.rowNumber>t&&(t=e.rowNumber),e.colNumber>o&&(o=e.colNumber),e.scopeID>r&&(r=e.scopeID),e.rowNumber<n&&(n=e.rowNumber),e.colNumber<a&&(a=e.colNumber),e.scopeID<l&&(l=e.scopeID))})))),{maxRowNumber:t,maxColNumber:o,maxScopeID:r,minRowNumber:n,minColNumber:a,minScopeID:l}}const y=(e,t)=>{if(t.colNumber>=e.colNumber){if(t.colNumber===e.colNumber&&("body"===e.cellType||"body"===t.cellType||"unknown"===e.cellType||"unknown"===t.cellType))return!1;if(e.cellType===t.cellType)return!0;if("corner"===e.cellType)return"column"===t.cellType;if("row"===e.cellType)return"body"===t.cellType}return!1};function v(e,t){if(0===e.length)return"";const o=(e=>e.map((e=>e.filter((e=>e.every((e=>"filler"!==e.rowType)))))).map((e=>({block:e,rect:b(e)}))).sort(((e,t)=>e.rect.maxRowNumber>t.rect.minRowNumber?1:e.rect.minRowNumber<t.rect.maxRowNumber?-1:e.rect.maxColNumber>t.rect.minColNumber?1:e.rect.minColNumber<t.rect.maxColNumber?-1:e.block.every((e=>e.every((e=>"footer"===e.rowType||"header"===e.rowType))))?1:t.block.every((e=>e.every((e=>"footer"===e.rowType||"header"===e.rowType))))?-1:0)).map((e=>e.block)))(e),r=[o[0]];for(let e=1;e<o.length;e++){const t=c(c(o[e])),n=c(c(c(r)));y(n,t)?r[r.length-1]=m(r[r.length-1],o[e]):r.push(o[e])}if(r.some((e=>e.some((e=>e.length!==r[0][0].length)))))throw new Error("Data blocks join failed");const n=[],a=[];for(const e of i(r))if(e.every((e=>"details"!==e.rowType&&"footer"!==e.rowType))){const t=g(e);a.includes(t)||(n.push(e),a.push(t))}else n.push(e);const l=[];for(let e=n.length-1;e>=0;e--)if(n[e].every((e=>"footer"===e.rowType))){const t=g(n[e]);l.includes(t)?n.splice(e,1):l.push(t)}if(n.length>0){const e=[];for(let t=0;t<n[0].length;t++){const o=[];for(let e=0;e<n.length;e++)o.push(n[e][t]);if(o.every((e=>"details"!==e.rowType))){const r=g(o);if(e.includes(r)){for(let e=0;e<n.length;e++)n[e].splice(t,1);t--}else e.push(r)}}}return n.map((e=>e.map((e=>T(e.value,t))).join(t.colSeparator))).join(t.rowSeparator)}const w=e=>`${e.colNumber}/${e.rowNumber}/${e.rowSpan}/${e.scopeID}/${e.rowType}/${JSON.stringify(e.value)}`,g=e=>e.map(w).join("|"),S=(e,t)=>e.children.filter((e=>"VirtualNode"===e.type&&e.tagName===t)),h=(e,t)=>{var o,r;if(["TABLE","SVG"].includes(e.tagName))return;const n=d(e,"rawValue",void 0);if(void 0!==n)return n;const a=(null!==(r=null===(o=c(t.filter((t=>t.id===e.properties.id))))||void 0===o?void 0:o.children)&&void 0!==r?r:e.children).filter((e=>"VirtualNode"===e.type));for(const e of a){const o=h(e,t);if(void 0!==o)return o}},T=(e,t)=>{var o;switch(typeof e){case"number":return N(e.toString(),t);case"string":return N(e,t);case"boolean":return e?"True":"False";case"object":return"function"==typeof(null===(o=e)||void 0===o?void 0:o.toISOString)?e.toISOString():"";default:return""}},N=(e,t)=>{const o=e.includes(t.rowSeparator)||e.includes(t.colSeparator)||e.includes(t.quotationSymbol),r=o?e.replace(new RegExp(t.quotationSymbol,"g"),`${t.quotationSymbol}${t.quotationSymbol}`):e;return o?`${t.quotationSymbol}${r}${t.quotationSymbol}`:r};!function(){if(window&&window.arjsViewer&&"function"==typeof window.arjsViewer.registerExport){const o={formatKey:"tabular-data",friendlyName:"Tabular data",settingsDescriptors:[{name:"colSeparator",type:"string",label:"Columns Separator",category:"csv"},{name:"rowSeparator",type:"string",label:"Rows Separator",category:"csv"},{name:"quotationSymbol",type:"string",label:"Quotation Symbol",category:"csv"},{name:"tableSeparator",type:"string",label:"Tables Separator",category:"csv"},{name:"outputType",type:"enum",label:"Output Type",enumValues:{plain:"Plain text",zip:"ZIP"},category:"csv"},{name:"filename",type:"string",label:"File Name"}],defaultSettings:{filename:"ActiveReports",colSeparator:",",rowSeparator:"\\n",quotationSymbol:'"',tableSeparator:"===============",outputType:"plain"},invoke:(o,r,n,a)=>e(this,void 0,void 0,(function*(){const{filename:e}=r,l=t(r,["filename"]),i={csvSettings:{colSeparator:s(l.colSeparator),rowSeparator:s(l.rowSeparator),quotationSymbol:s(l.quotationSymbol),tableSeparator:s(l.tableSeparator),outputType:l.outputType},filename:l.filename,format:"csv"},c=yield p(o._renderer,i,n,a);return{data:c.data,download:t=>c.download(t||e)}}))};window.arjsViewer.registerExport(o)}}();export{p as exportDocument};
